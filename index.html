<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gravity Simulator v3.4 [MASTER-SYNC]</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    
    <style>
        :root {
            --bg-color: #000000;
            --surface-color: #121212;
            --panel-color: #1c1c1e;
            --accent-color: #00FFCC;
            --accent-glow: rgba(0, 255, 204, 0.3);
            --danger-color: #ff3b30;
            --warning-color: #ffcc00;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --border-color: #2c2c2e;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, sans-serif;
            margin: 0; padding: 0;
            display: flex; justify-content: center;
            height: 100vh; width: 100vw;
            overflow: hidden;
        }

        .app-container {
            width: 100%;
            max-width: 480px;
            background: var(--bg-color);
            display: flex; flex-direction: column;
            position: relative;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }

        header {
            padding: 20px 24px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color);
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
            z-index: 10;
        }

        .brand h1 {
            margin: 0; font-size: 16px; font-weight: 800;
            letter-spacing: -0.5px; color: var(--accent-color);
            text-transform: uppercase;
        }

        .sync-badge {
            font-size: 9px; padding: 2px 6px; border-radius: 4px;
            background: var(--border-color); color: var(--text-secondary);
            font-weight: bold; margin-top: 4px; width: fit-content;
        }

        .sync-badge.online {
            color: var(--accent-color); background: rgba(0, 255, 204, 0.1);
            border: 1px solid var(--accent-color);
        }

        .clock { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 500; }

        .glucose-card {
            padding: 40px 24px; text-align: center;
            display: flex; flex-direction: column; align-items: center;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }

        .label-main { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }

        .glucose-value-container { display: flex; align-items: baseline; justify-content: center; }

        .glucose-value {
            font-size: 100px; font-weight: 800; line-height: 1;
            color: var(--accent-color); text-shadow: 0 0 30px var(--accent-glow);
        }

        .glucose-unit-arrow { display: flex; flex-direction: column; align-items: flex-start; margin-left: 12px; }
        .trend-arrow { font-size: 40px; line-height: 1; color: var(--accent-color); }
        .unit { font-size: 14px; font-weight: 600; color: var(--text-secondary); }

        .ai-status-msg { margin-top: 16px; font-size: 13px; font-weight: 600; padding: 6px 16px; border-radius: 20px; background: rgba(255,255,255,0.05); }

        .metrics-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 24px; margin-bottom: 20px; }
        .metric-tile { background: var(--surface-color); padding: 16px; border-radius: 16px; border: 1px solid var(--border-color); text-align: center; }
        .m-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 4px;}
        .m-value { font-size: 18px; font-weight: 600; }

        .chart-section { flex: 1; padding: 0 12px; min-height: 200px; display: flex; flex-direction: column; }
        .chart-container { flex: 1; background: var(--surface-color); border-radius: 20px; padding: 16px; border: 1px solid var(--border-color); position: relative; }

        .log-section { height: 60px; margin: 12px 24px; padding: 8px; background: #0a0a0a; border-radius: 12px; border: 1px solid #222; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 9px; color: #444; }

        .controls-panel { padding: 20px 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: var(--bg-color); border-top: 1px solid var(--border-color); }
        button { height: 48px; border-radius: 12px; border: none; font-family: inherit; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        button:active { transform: scale(0.96); opacity: 0.8; }
        .btn-carbs { background: #3a2a1d; color: #ff9500; }
        .btn-pizza { background: #2c1c1c; color: #ff3b30; }
        .btn-insulin { background: rgba(0, 255, 204, 0.1); color: var(--accent-color); border: 1px solid var(--accent-color); }
        
        .footer-settings { grid-column: span 2; display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        .speed-wrapper { font-size: 10px; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }
        select { background: #1a1a1a; color: white; border: 1px solid #333; padding: 2px 4px; border-radius: 4px; font-size: 10px; }
        
        @media (max-height: 700px) { .glucose-card { padding: 20px; } .glucose-value { font-size: 70px; } .metrics-row { margin-bottom: 10px; } }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="brand">
            <h1>Gravity Sim <span style="font-weight:300">v3.4</span></h1>
            <div id="sync-status" class="sync-badge">CONNECTING...</div>
        </div>
        <div id="clock" class="clock">00:00</div>
    </header>

    <div class="glucose-card">
        <div class="label-main">Glucemia Actual</div>
        <div class="glucose-value-container">
            <div id="glucose-val" class="glucose-value">--</div>
            <div class="glucose-unit-arrow">
                <span id="trend-arrow" class="trend-arrow">‚Üí</span>
                <span class="unit">mg/dL</span>
            </div>
        </div>
        <div id="ai-status" class="ai-status-msg">Enlazando con la nube...</div>
    </div>

    <div class="metrics-row">
        <div class="metric-tile">
            <span class="m-label">IOB (Activa)</span>
            <span id="val-iob" class="m-value">0.00 U</span>
        </div>
        <div class="metric-tile">
            <span class="m-label">Proyecci√≥n 30m</span>
            <span id="val-pred" class="m-value">--</span>
        </div>
    </div>

    <div class="chart-section">
        <div class="chart-container">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div id="log" class="log-section"></div>

    <div class="controls-panel">
        <button class="btn-carbs" onclick="addMeal(30, 'simple')">üçé +30g Carbs</button>
        <button class="btn-pizza" onclick="addMeal(90, 'pizza')">üçï Pizza (90g)</button>
        <button class="btn-insulin" onclick="addInsulin(2)">üíâ +2u Insulina</button>
        <button class="btn-insulin" onclick="addInsulin(10)" style="font-weight:900">+10u Bolo</button>
        
        <div class="footer-settings">
            <div class="speed-wrapper">
                <span>VELOCIDAD</span>
                <select id="speed-sel" onchange="updateSpeed()">
                    <option value="1000" selected>1s=1m</option>
                    <option value="200">5x</option>
                    <option value="50">20x</option>
                </select>
            </div>
            <button onclick="resetSim()" style="background:none; color:#444; border:none; font-size:10px; cursor:pointer;">RESET</button>
        </div>
    </div>
</div>

<script>
    // --- ENGINE ---
    const GB_BASE = 110.0;
    const IB_BASE = 15.0;
    const P1 = 0.01;
    const P2 = 0.0125;
    const P3_BASE = 0.00005;

    class Meal {
        constructor(carbs, time, type) { this.carbs = carbs; this.time = time; this.type = type; }
        getRate(t) {
            const dt = t - this.time;
            if (dt < 0) return 0;
            const totalRise = this.carbs * 8.5;
            const beta = (this.type === 'simple') ? (1.0/45.0) : (1.0/140.0);
            return totalRise * (beta**2) * dt * Math.exp(-beta * dt);
        }
    }

    class Patient {
        constructor() { this.reset(); }
        reset() {
            this.G = GB_BASE; this.I = IB_BASE; this.X = 0;
            this.meals = []; this.history = [];
        }
        step(t, dt) {
            const isDawn = t >= 240 && t <= 480;
            let currentP3 = P3_BASE;
            if (isDawn) currentP3 *= 0.65;
            let Ra = 0;
            this.meals.forEach(m => Ra += m.getRate(t));
            let secretion = (this.G > 100) ? (this.G - 100) * 0.45 : 0;
            const targetI = IB_BASE + secretion;
            this.I += (targetI - this.I) * 0.12 * dt;
            this.X += (-P2 * this.X + currentP3 * (this.I - IB_BASE)) * dt;
            const dG = -(P1 + this.X) * this.G + (P1 * GB_BASE) + Ra;
            this.G += dG * dt;
            if (this.G < 15) this.G = 15;
            if (this.G > 600) this.G = 600;
        }
    }

    // --- CLOUD SYNC (GUN.js) ---
    const gun = Gun([
        'https://gun-manhattan.herokuapp.com/gun',
        'https://peer.wall.org/gun',
        'https://gundb-relay.herokuapp.com/gun'
    ]);
    
    // Nueva llave exclusiva v3.4 MASTER-SYNC
    const cloud = gun.get('miguel-gravity-master-v3-4');
    let lastInboundTs = 0;

    function syncOut() {
        const now = Date.now();
        cloud.put({ 
            G: patient.G, 
            I: patient.I, 
            X: patient.X, 
            time: time,
            ts: now 
        });
        const b = document.getElementById('sync-status');
        if(b) { b.innerText = "MASTER-SYNC"; b.classList.add('online'); }
    }

    cloud.on((data) => {
        if (!data || data.ts <= lastInboundTs) return;
        
        lastInboundTs = data.ts;
        
        // Sincronizaci√≥n agresiva: el √∫ltimo dato de la nube manda
        patient.G = data.G;
        patient.I = data.I;
        patient.X = data.X;
        
        // Sincronizar tiempo si hay desfase
        if (Math.abs(data.time - time) > 2) {
            time = data.time;
        }
        
        const b = document.getElementById('sync-status');
        if(b) { b.innerText = "CLOUD-LINKED"; b.classList.add('online'); }
    });

    // --- LOGIC ---
    const patient = new Patient();
    let time = 0; let speed = 1000; let timerId = null; let chart = null;

    function addLog(msg) {
        const log = document.getElementById('log');
        if(!log) return;
        const h = Math.floor(time / 60).toString().padStart(2, '0');
        const m = Math.floor(time % 60).toString().padStart(2, '0');
        const div = document.createElement('div');
        div.innerText = `[${h}:${m}] ${msg}`;
        log.prepend(div);
    }

    function addMeal(c, t) { 
        patient.meals.push(new Meal(c, time, t)); 
        addLog(`+${c}g Carbs`); 
        syncOut(); 
    }

    function addInsulin(u) { 
        patient.I += u * 12.5; 
        addLog(`+${u}u Insulina`); 
        syncOut(); 
    }

    function updateSpeed() { speed = parseInt(document.getElementById('speed-sel').value); clearTimeout(timerId); loop(); }
    function resetSim() { 
        time = 0; 
        patient.reset(); 
        if(chart) { 
            chart.data.labels = []; 
            chart.data.datasets[0].data = []; 
            chart.update(); 
        } 
        addLog("Reset."); 
        syncOut(); 
    }

    function initChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(!ctx) return;
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ data: [], borderColor: '#00FFCC', backgroundColor: 'rgba(0, 255, 204, 0.05)', borderWidth: 3, pointRadius: 0, tension: 0.4, fill: true }] },
            options: {
                responsive: true, maintainAspectRatio: false, animation: false,
                scales: { x: { display: false }, y: { min: 0, max: 400, grid: { color: '#222', drawBorder: false }, ticks: { color: '#444', font: { size: 9 } } } },
                plugins: { legend: { display: false }, annotation: { annotations: { t: { type: 'box', yMin: 70, yMax: 140, backgroundColor: 'rgba(0, 255, 100, 0.02)', borderWidth: 0 } } } }
            }
        });
    }

    function loop() {
        const lastG = patient.G;
        time += 1;
        patient.step(time, 1);
        
        const h = Math.floor(time / 60).toString().padStart(2, '0');
        const m = Math.floor(time % 60).toString().padStart(2, '0');
        const clockEl = document.getElementById('clock');
        if(clockEl) clockEl.innerText = `${h}:${m}`;
        
        const gVal = Math.round(patient.G);
        const elVal = document.getElementById('glucose-val');
        if(elVal) elVal.innerText = gVal;
        
        const iobEl = document.getElementById('val-iob');
        if(iobEl) iobEl.innerText = `${Math.max(0, (patient.I - IB_BASE) / 10).toFixed(2)} U`;

        const aiStatus = document.getElementById('ai-status');
        if (aiStatus && elVal) {
            if (gVal < 70) { aiStatus.innerText = "üö® HIPOGLUCEMIA"; aiStatus.style.color = "var(--danger-color)"; elVal.style.color = "var(--danger-color)"; }
            else if (gVal > 180) { aiStatus.innerText = "‚ö†Ô∏è HIPERGLUCEMIA"; aiStatus.style.color = "var(--warning-color)"; elVal.style.color = "var(--warning-color)"; }
            else { aiStatus.innerText = "‚úÖ ESTADO √ìPTIMO"; aiStatus.style.color = "var(--accent-color)"; elVal.style.color = "var(--accent-color)"; }
        }

        const diff = patient.G - lastG;
        const tr = document.getElementById('trend-arrow');
        if (tr && elVal) {
            if (diff > 1.2) tr.innerText = "‚Üë"; else if (diff > 0.4) tr.innerText = "‚Üó";
            else if (diff < -1.2) tr.innerText = "‚Üì"; else if (diff < -0.4) tr.innerText = "‚Üò";
            else tr.innerText = "‚Üí";
            tr.style.color = elVal.style.color;
        }

        const predEl = document.getElementById('val-pred');
        if(predEl) predEl.innerText = `${Math.round(patient.G + (diff * 30))} mg/dL`;

        if(chart) {
            chart.data.labels.push(""); 
            chart.data.datasets[0].data.push(patient.G);
            if (chart.data.labels.length > 100) { 
                chart.data.labels.shift(); 
                chart.data.datasets[0].data.shift(); 
            }
            chart.update('none');
        }

        // Sincronizaci√≥n forzada cada 2 ticks
        if (time % 2 === 0) syncOut();
        timerId = setTimeout(loop, speed);
    }

    window.onload = () => { 
        initChart(); 
        loop(); 
    };
</script>

</body>
</html>
